<!DOCTYPE html>
<html>
<head>
    <title>Invoice Review</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; }
        .actions button {
            padding: 10px 20px; margin-right: 10px; cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Invoice Review</h2>
    <p><b>Checkpoint ID:</b> <span id="checkpoint_id"></span></p>
    <p><b>Reason for Hold:</b> <span id="reason"></span></p>

    <h3>Invoice Details</h3>
    <table>
        <tbody id="invoice_details"></tbody>
    </table>

    <h3>Line Items</h3>
    <table>
        <thead>
            <tr>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="line_items"></tbody>
    </table>

    <h3>PO Numbers</h3>
    <table>
        <thead>
            <tr>
                <th>PO ID</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody id="po_numbers"></tbody>
    </table>

    <h3>Attachments</h3>
    <table>
        <tbody id="attachments_risk"></tbody>
    </table>

    <h3>Actions</h3>
    <div class="actions">
        <button onclick="submitDecision('ACCEPT')">ACCEPT</button>
        <button onclick="submitDecision('REJECT')">REJECT</button>
    </div>
</div>

<script>
async function loadData() {
    const urlParams = new URLSearchParams(window.location.search);
    const checkpoint_id = urlParams.get("checkpoint_id");
    document.getElementById("checkpoint_id").innerText = checkpoint_id;

    const resp = await fetch("/api/checkpoint/" + checkpoint_id);
    const data = await resp.json();
    const st = data.state;

    const inv = st.CHECKPOINT_HITL?.invoice_metadata || st.input_invoice || {};

    // Only include actual HITL reasons
    let reasons = [];

    // If HITL explicitly paused it
    if (st.CHECKPOINT_HITL?.paused_reason) {
        reasons.push(st.CHECKPOINT_HITL.paused_reason);
    }

    // Detect dynamic mismatches
    const poTotal = (inv.matched_pos || []).reduce((sum, po) => sum + (po.amount || 0), 0);
    if (inv.amount !== poTotal) reasons.push("Amount Mismatch");

    const matchedVendor = st.RETRIEVE?.matched_vendor_name || "";
    if (matchedVendor && inv.vendor_name.toLowerCase() !== matchedVendor.toLowerCase()) reasons.push("Vendor Mismatch");

    (inv.line_items || []).forEach((li, idx) => {
        if (li.qty * li.unit_price !== li.total) reasons.push(`Line Item ${idx+1} Total Mismatch`);
    });

    document.getElementById("reason").innerText = reasons.join("; ") || "N/A";

    // Invoice Details
    let invoiceDetails = `
        <tr><th>Invoice ID</th><td>${inv.invoice_id || ""}</td></tr>
        <tr><th>Vendor Name</th><td>${inv.vendor_name || ""}</td></tr>
        <tr><th>Invoice Date</th><td>${inv.invoice_date || ""}</td></tr>
        <tr><th>Due Date</th><td>${inv.due_date || ""}</td></tr>
        <tr><th>Amount</th><td>${inv.amount || ""}</td></tr>
        <tr><th>Currency</th><td>${inv.currency || ""}</td></tr>
    `;
    document.getElementById("invoice_details").innerHTML = invoiceDetails;

    // Line Items
    const items = inv.line_items || [];
    const lineItemsHTML = items.map(it => `
        <tr>
            <td>${it.desc || ""}</td>
            <td>${it.qty || ""}</td>
            <td>${it.unit_price || ""}</td>
            <td>${it.total || ""}</td>
        </tr>
    `).join("");
    document.getElementById("line_items").innerHTML = lineItemsHTML;

    // PO Numbers
    const pos = (inv.matched_pos && inv.matched_pos.length > 0) 
        ? inv.matched_pos 
        : (st.RETRIEVE?.matched_pos || []);
    const poHTML = pos.map(po => `
        <tr>
            <td>${po.po_id || ""}</td>
            <td>${po.amount || ""}</td>
        </tr>
    `).join("");
    document.getElementById("po_numbers").innerHTML = poHTML;

    // Attachments
    const attachmentsHTML = `
        <tr><th>Attachments</th><td>${(inv.attachments || []).join(", ")}</td></tr>
    `;
    document.getElementById("attachments_risk").innerHTML = attachmentsHTML;
}

async function submitDecision(decision) {
    const urlParams = new URLSearchParams(window.location.search);
    const checkpoint_id = urlParams.get("checkpoint_id");

    const resp = await fetch("/human-review/decision", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            checkpoint_id,
            decision,
            reviewer_id: "Reviewer1",
            notes: ""
        })
    });

    const data = await resp.json();
    alert("Decision submitted: " + decision);
}

loadData();
</script>
</body>
</html>
