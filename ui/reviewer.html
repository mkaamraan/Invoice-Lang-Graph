<!DOCTYPE html>
<html>
<head>
    <title>Invoice Review</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; }
        .actions button { padding: 10px 20px; margin-right: 10px; cursor: pointer; }
        pre { background-color: #f8f8f8; padding: 10px; max-height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
<div class="container">
    <h2>Invoice Review</h2>
    <p><b>Checkpoint ID:</b> <span id="checkpoint_id"></span></p>
    <p><b>Reason for Hold:</b> <span id="reason"></span></p>

    <h3>Invoice Details</h3>
    <table><tbody id="invoice_details"></tbody></table>

    <h3>Line Items</h3>
    <table>
        <thead><tr><th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
        <tbody id="line_items"></tbody>
    </table>

    <h3>Matched PO(s)</h3>
    <table>
        <thead><tr><th>PO ID</th><th>Amount</th></tr></thead>
        <tbody id="po_numbers"></tbody>
    </table>

    <h3>Matched GRN(s)</h3>
    <table>
        <thead><tr><th>GRN ID</th><th>Amount</th></tr></thead>
        <tbody id="grn_numbers"></tbody>
    </table>

    <h3>Attachments & Risk</h3>
    <table><tbody id="attachments_risk"></tbody></table>

    <h3>Actions</h3>
    <div class="actions">
        <button id="acceptBtn" onclick="submitDecision('ACCEPT')">ACCEPT</button>
        <button id="rejectBtn" onclick="submitDecision('REJECT')">REJECT</button>
    </div>

    <h3>Logs</h3>
    <pre id="logsBox"></pre>

    <h3>Final State</h3>
    <pre id="stateBox"></pre>
</div>

<script>
async function loadData() {
    const checkpoint_id = new URLSearchParams(window.location.search).get("checkpoint_id");
    document.getElementById("checkpoint_id").textContent = checkpoint_id;

    const resp = await fetch("/api/checkpoint/" + checkpoint_id);
    const data = await resp.json();
    const st = data.state;

    const inv = st.CHECKPOINT_HITL?.invoice_metadata || st.input_invoice || {};

    // Reason for hold
    const reasonFromState = st.CHECKPOINT_HITL?.paused_reason;
    let reasons = [];
    if(reasonFromState) reasons.push(reasonFromState);
    document.getElementById("reason").textContent = reasons.join("; ") || "N/A";

    // Invoice details
    document.getElementById("invoice_details").innerHTML = `
        <tr><th>Invoice ID</th><td>${inv.invoice_id||""}</td></tr>
        <tr><th>Vendor Name</th><td>${inv.vendor_name||""}</td></tr>
        <tr><th>Invoice Date</th><td>${inv.invoice_date||""}</td></tr>
        <tr><th>Amount</th><td>${inv.amount||""}</td></tr>
        <tr><th>Currency</th><td>${inv.currency||""}</td></tr>
    `;

    // Line items
    const items = inv.line_items||[];
    document.getElementById("line_items").innerHTML = items.map(it => `
        <tr><td>${it.desc||""}</td><td>${it.qty||""}</td><td>${it.unit_price||""}</td><td>${it.total||""}</td></tr>
    `).join("");

    // Matched POs
    const pos = inv.matched_pos||[];
    document.getElementById("po_numbers").innerHTML = pos.map(po => `
        <tr><td>${po.po_id||""}</td><td>${po.amount||""}</td></tr>
    `).join("");

    // Matched GRNs
    const grns = inv.matched_grns||[];
    document.getElementById("grn_numbers").innerHTML = grns.map(grn => `
        <tr><td>${grn.grn_id||""}</td><td>${grn.amount||""}</td></tr>
    `).join("");

    // Attachments & Risk
    document.getElementById("attachments_risk").innerHTML = `
        <tr><th>Attachments</th><td>${(inv.attachments||[]).join(", ")}</td></tr>
        <tr><th>Risk Score</th><td>${inv.risk_score??"N/A"}</td></tr>
    `;

    // Logs
    document.getElementById("logsBox").textContent = (st.logs||[]).join("\n");
}

async function submitDecision(decision) {
    const checkpoint_id = new URLSearchParams(window.location.search).get("checkpoint_id");
    const resp = await fetch("/human-review/decision", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({checkpoint_id, decision, reviewer_id:"Reviewer1", notes:""})
    });
    const data = await resp.json();

    // disable buttons
    document.getElementById("acceptBtn").disabled = true;
    document.getElementById("rejectBtn").disabled = true;

    // post-decision logs & state
    document.getElementById("logsBox").textContent = (data.post_decision_logs||[]).join("\n");
    document.getElementById("stateBox").textContent = JSON.stringify(data.final_state, null, 2);
    alert("Decision submitted: " + decision);
}

loadData();
</script>
</body>
</html>
